<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHEI REALTIME 2026</title>
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="shortcut icon" href="icon.png" type="image/x-icon">
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --text: #c9d1d9; --border: #30363d; --sub-text: #8b949e; --accent: #3b82f6; }
        .light-mode { --bg: #ffffff; --card: #f6f8fa; --text: #24292f; --border: #d0d7de; --sub-text: #57606a; --accent: #2563eb; }
        
        body { font-family: 'JetBrains Mono', monospace; background-color: var(--bg); color: var(--text); overflow: hidden; transition: 0.3s; margin: 0; }
        .font-rowx { font-family: 'Orbitron', sans-serif; }
        
        nav { display: flex; align-items: center; padding: 0 24px; height: 75px; background: var(--card); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 50; justify-content: space-between; }
        
        .marquee-container { flex: 1; height: 100%; overflow: hidden; margin: 0 20px; border-left: 1px solid var(--border); border-right: 1px solid var(--border); display: flex; align-items: center; position: relative; min-width: 0; }
        .marquee-text { display: inline-block; white-space: nowrap; position: absolute; animation: marquee 25s linear infinite; font-size: 11px; font-weight: 700; color: var(--sub-text); padding-left: 100%; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        th { background: var(--card); color: var(--sub-text); font-size: 10px; padding: 12px 24px; border-bottom: 2px solid var(--border); text-align: left; text-transform: uppercase; }
        td { padding: 12px 24px; border-bottom: 1px solid var(--border); font-size: 13px; color: var(--text); transition: color 0.3s; }
        
        .menu-btn { position: relative; width: 30px; height: 20px; cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; shrink-0; }
        .menu-btn span { display: block; width: 100%; height: 3px; background: var(--text); border-radius: 3px; transition: 0.3s; }
        .menu-btn.active span:nth-child(1) { transform: translateY(8.5px) rotate(45deg); }
        .menu-btn.active span:nth-child(2) { opacity: 0; }
        .menu-btn.active span:nth-child(3) { transform: translateY(-8.5px) rotate(-45deg); }

        #nav-popup-menu { background: var(--card); border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.5); border-radius: 12px; }
        .theme-box { background: var(--bg); border: 1px solid var(--border); width: 42px; height: 42px; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text); shrink-0; }
    </style>
</head>
<body class="dark-mode">

    <div class="flex flex-col h-screen relative">
        <nav>
            <div class="logo-area flex flex-col shrink-0">
                <span class="text-2xl font-bold font-rowx text-blue-500">R.O.W.X</span>
                <span class="text-[7px] font-bold tracking-[0.2em] opacity-40 uppercase">PHEI EDITION 2026</span>
            </div>
            <div class="marquee-container">
                <div class="marquee-text uppercase" id="marquee-text">SYSTEM READY // NODE ASIA-1 // SECURE CONNECTED</div>
            </div>
            <div class="flex items-center gap-4 shrink-0">
                <div class="theme-box" onclick="toggleTheme()">
                    <svg id="sun-icon" fill="currentColor" viewBox="0 0 24 24" class="w-6 h-6 block"><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></svg>
                    <svg id="moon-icon" fill="currentColor" viewBox="0 0 24 24" class="w-6 h-6 hidden"><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7z"/></svg>
                </div>
                <div id="menu-trigger" class="menu-btn" onclick="toggleMenu()">
                    <span></span><span></span><span></span>
                </div>
            </div>
        </nav>

        <main class="flex-1 overflow-y-auto">
            <div class="p-4 border-b border-[var(--border)] bg-[var(--card)]/30 flex justify-between items-center">
                <div class="flex items-center gap-2" id="view-header-icon">
                    <svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    <h2 id="view-title" class="text-[10px] font-bold text-blue-500 uppercase tracking-[0.3em]">REALTIME LEADS</h2>
                </div>
                
                <div class="flex items-center gap-3">
                    <div id="search-container" class="hidden">
                        <input type="text" id="clickSearch" class="border border-[var(--border)] bg-[var(--bg)] text-[var(--text)] px-3 py-1 rounded text-xs outline-none w-40" placeholder="Cari..." onkeyup="filterClicks()">
                    </div>
                    <div class="bg-blue-500/10 border border-blue-500/20 px-3 py-1 rounded-lg flex flex-col items-end">
                        <span class="text-[7px] font-bold text-blue-500 uppercase">Clicks</span>
                        <span id="total-clicks" class="text-xs font-bold text-blue-500 font-mono">0</span>
                    </div>
                    <div class="bg-green-500/10 border border-green-500/20 px-3 py-1 rounded-lg flex flex-col items-end">
                        <span class="text-[7px] font-bold text-green-500 uppercase">Earnings</span>
                        <span id="total-earnings" class="text-xs font-bold text-green-500 font-mono">$0.00</span>
                    </div>
                </div>
            </div>

            <table id="data-table" class="w-full">
                <thead id="table-head"></thead>
                <tbody id="main-table-body"></tbody>
            </table>
        </main>
    </div>

<script>
const mainTable = document.getElementById('main-table-body');
const tableHead = document.getElementById('table-head');
const totalEarningsEl = document.getElementById('total-earnings');
const totalClicksEl = document.getElementById('total-clicks');
const marqueeEl = document.getElementById('marquee-text');

let leadsData = [];
let clicksData = [];
let currentView = 'live';

const svgIcons = {
    bolt: `<svg class="w-5 h-5 text-blue-500" fill="currentColor" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>`,
    // TROPHY SOLID - UNTUK HEADER PERFORMANCE
    chart: `<svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v1c0 2.55 1.92 4.66 4.43 4.94C9.45 12.05 11 14 11 14v5H7v2h10v-2h-4v-5s1.55-1.95 2.57-4.06C18.08 9.66 20 7.55 20 5V4c0-1.1-.9-2-2-2zM6 4h2v3H6V4zm12 3h-2V4h2v3z"/></svg>`,
    signal: `<svg class="w-5 h-5 text-purple-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 11a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Zm0-9a9 9 0 0 0-9 9c0 2.48 1.01 4.72 2.65 6.34L3.5 22h17l-2.15-4.66A9 9 0 0 0 12 2Zm0 14a5 5 0 1 1 0-10 5 5 0 0 1 0 10Z"/></svg>`,
    crown: `<svg class="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 24 24"><path d="M5 16L3 5L8.5 10L12 4L15.5 10L21 5L19 16H5M19 19C19 19.6 18.6 20 18 20H6C5.4 20 5 19.6 5 19V18H19V19Z"/></svg>`,
    // MEDAL SOLID - UNTUK LIST PERFORMANCE
    medal: `<svg class="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="2 2 20 20"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>`,
    fire: `<svg class="w-4 h-4 text-[#fe3c72]" fill="currentColor" viewBox="0 0 24 24"><path d="M12.536 21.432a9.122 9.122 0 0 1-5.187-2.07c-3.153-2.535-3.321-7.143-1.464-10.12a.375.375 0 0 1 .632.023c.35 1.05.7 1.87 1.144 2.505.772 1.103 1.956 1.767 3.327 1.767 1.114 0 2.214-.42 2.768-1.574a4.07 4.07 0 0 0 .393-1.685c0-2.31-1.611-3.665-2.617-5.462a.362.362 0 0 1 .49-.49c4.28 1.914 6.945 6.007 6.945 9.778 0 4.283-2.924 7.338-6.431 7.338"/></svg>`
};

function getFlag(country) {
    if (!country) return 'id'; 
    let code = country.toLowerCase();
    return code === 'uk' ? 'gb' : code;
}

function toggleMenu() {
    const trigger = document.getElementById('menu-trigger');
    const existing = document.getElementById('nav-popup-menu');
    if (existing) {
        trigger.classList.remove('active');
        existing.remove();
    } else {
        trigger.classList.add('active');
        const menu = document.createElement('div');
        menu.id = 'nav-popup-menu';
        menu.className = "fixed top-16 right-4 w-56 z-[999] p-2 flex flex-col gap-1";
        menu.innerHTML = `
            <button onclick="switchView('live')" class="p-3 rounded-lg hover:bg-blue-500/10 text-[var(--text)] w-full text-left font-bold text-[10px] uppercase flex items-center gap-3">${svgIcons.bolt} Realtime Leads</button>
            <button onclick="switchView('perf')" class="p-3 rounded-lg hover:bg-green-500/10 text-[var(--text)] w-full text-left font-bold text-[10px] uppercase flex items-center gap-3">${svgIcons.chart} Performance</button>
            <button onclick="switchView('traffic')" class="p-3 rounded-lg hover:bg-purple-500/10 text-[var(--text)] w-full text-left font-bold text-[10px] uppercase flex items-center gap-3">${svgIcons.signal} Live Traffic</button>
        `;
        document.body.appendChild(menu);
        setTimeout(() => document.addEventListener('click', function closeMenu(e) {
            if(!menu.contains(e.target) && e.target !== trigger) {
                trigger.classList.remove('active');
                menu.remove();
                document.removeEventListener('click', closeMenu);
            }
        }, {capture: true}), 10);
    }
}

function switchView(view) {
    currentView = view;
    document.getElementById('search-container').classList.toggle('hidden', view !== 'traffic');
    const headerIcon = document.getElementById('view-header-icon');
    if(view === 'live') headerIcon.innerHTML = `${svgIcons.bolt} <h2 class="text-[10px] font-bold text-blue-500 uppercase tracking-[0.3em]">REALTIME LEADS</h2>`;
    else if (view === 'perf') headerIcon.innerHTML = `${svgIcons.chart} <h2 class="text-[10px] font-bold text-green-500 uppercase tracking-[0.3em]">PERFORMANCE</h2>`;
    else headerIcon.innerHTML = `${svgIcons.signal} <h2 class="text-[10px] font-bold text-purple-500 uppercase tracking-[0.3em]">LIVE TRAFFIC (CLICKS)</h2>`;
    updateDisplay();
}

function updateDisplay() {
    mainTable.innerHTML = "";
    let kingId = "", topVal = 0, grandTotal = 0;
    const perfMap = {};
    
    leadsData.forEach(l => {
        const p = parseFloat(l.payout);
        grandTotal += p;
        if(!perfMap[l.click_id]) perfMap[l.click_id] = {...l, total:0, count:0};
        perfMap[l.click_id].total += p;
        perfMap[l.click_id].count++;
    });

    totalEarningsEl.innerText = `$${grandTotal.toFixed(2)}`;
    
    // FIX CLICKS MAX 1000+
    const clickCount = clicksData.length;
    totalClicksEl.innerText = clickCount > 1000 ? "1000+" : clickCount;

    const sortedPerf = Object.values(perfMap).sort((a,b) => b.total - a.total);
    if(sortedPerf.length > 0) { 
        kingId = sortedPerf[0].click_id; 
        topVal = sortedPerf[0].total; 
        // FIX MARQUEE HIGH PAYOUT
        marqueeEl.innerHTML = `üèÜ HIGH PAYOUT: <span class="text-yellow-500 font-bold">${kingId}</span> ($${topVal.toFixed(2)}) // STATUS: SECURE // NODE ASIA-1 // SECURE CONNECTED`;
    }

    if (currentView === 'live') {
        tableHead.innerHTML = `<tr><th class="w-[20%]">TEAM</th><th class="w-[30%]">CLICK ID</th><th class="w-[20%]">COUNTRY</th><th class="w-[15%] text-center">TIME</th><th class="w-[15%] text-right">PAYOUT</th></tr>`;
        leadsData.forEach(d => {
            const row = mainTable.insertRow();
            row.innerHTML = `<td class="w-[20%] p-4 font-bold text-blue-500 uppercase">${d.oid||'USR'}</td><td class="w-[30%] font-mono text-xs text-[var(--text)] opacity-70 truncate">${d.click_id}</td><td class="w-[20%]"> <div class="flex items-center gap-2"><img src="https://flagicons.lipis.dev/flags/4x3/${getFlag(d.country)}.svg" class="w-5 shadow"><span class="text-sm font-bold uppercase">${d.country||'ID'}</span></div></td><td class="w-[15%] text-center text-[10px] opacity-50">${new Date(d.timestamp).toLocaleTimeString()}</td><td class="w-[15%] text-right font-bold text-green-500">$${parseFloat(d.payout).toFixed(2)}</td>`;
        });
    } else if (currentView === 'perf') {
        tableHead.innerHTML = `<tr><th class="w-[50%]">CLICK ID</th><th class="w-[25%] text-center">INFO</th><th class="w-[25%] text-right">PAYOUT</th></tr>`;
        sortedPerf.forEach(d => {
            const isKing = d.click_id === kingId;
            const row = mainTable.insertRow();
            // FIX ICON PERFORMANCE: King = Mahkota, Lainnya = Medal (Bukan bintang)
            row.innerHTML = `<td class="w-[50%] p-4"><div class="flex items-center gap-3">${isKing ? svgIcons.crown : svgIcons.medal}<span class="font-mono text-xs ${isKing ? 'text-yellow-500 font-bold' : 'text-[var(--text)] opacity-70'}">${d.click_id}</span></div></td><td class="w-[25%] text-center text-[10px] font-bold uppercase">${d.count} LEADS</td><td class="w-[25%] text-right font-bold text-green-500">$${d.total.toFixed(2)}</td>`;
        });
    } else {
        tableHead.innerHTML = `<tr><th class="w-[40%]">CLICK ID</th><th class="w-[20%]">COUNTRY</th><th class="w-[20%]">STATUS</th><th class="w-[20%] text-right">TIME</th></tr>`;
        filterClicks();
    }
}

function filterClicks() {
    if(currentView !== 'traffic') return;
    const s = document.getElementById('clickSearch').value.toLowerCase();
    mainTable.innerHTML = "";
    clicksData.forEach(c => {
        if(c.click_id.toLowerCase().includes(s) || (c.country||'').toLowerCase().includes(s)) {
            const row = mainTable.insertRow();
            row.innerHTML = `<td class="w-[40%] p-4 font-mono text-xs text-blue-400">${c.click_id}</td><td class="w-[20%]"><div class="flex items-center gap-2"><img src="https://flagicons.lipis.dev/flags/4x3/${getFlag(c.country)}.svg" class="w-5"><span class="text-sm font-bold uppercase">${c.country||'ID'}</span></div></td><td class="w-[20%]"><span class="text-[9px] bg-[#fe3c72]/10 text-[#fe3c72] px-2 py-0.5 rounded flex items-center gap-1 w-fit font-bold">${svgIcons.fire} REDIRECT</span></td><td class="w-[20%] text-right text-[10px] opacity-40">${new Date().toLocaleTimeString()}</td>`;
        }
    });
}

function handleData(data, type, isNew = false) {
    // FIX PUSHER DATA INCOMING
    const payload = typeof data === 'string' ? JSON.parse(data) : data;
    if (type === 'LEAD') {
        leadsData.unshift(payload); if (leadsData.length > 500) leadsData.pop();
        updateDisplay(); 
        if (isNew) {
            fetch(`https://api.telegram.org/bot8294616704:AAF7M8RQkNKdkJeNvVdeGFG7zrU26vo7sao/sendMessage?chat_id=-1002258281914&text=${encodeURIComponent('üî• *LEAD MASUK!* üî•\n\nüÜî ID: `' + payload.click_id + '` \nüí∞ Payout: $' + payload.payout)}&parse_mode=Markdown`).catch(e => {});
        }
    } else {
        clicksData.unshift(payload); if (clicksData.length > 1005) clicksData.pop();
        if(currentView === 'traffic' || leadsData.length === 0) updateDisplay();
    }
}

function toggleTheme() {
    const isLight = document.body.classList.toggle('light-mode');
    document.getElementById('sun-icon').classList.toggle('hidden', isLight);
    document.getElementById('moon-icon').classList.toggle('hidden', !isLight);
}

setInterval(() => {
    const now = new Date();
    if (now.getHours() === 7 && now.getMinutes() === 0 && now.getSeconds() === 0) {
        leadsData = []; clicksData = []; updateDisplay();
    }
}, 1000);

async function autoSync() {
    try {
        const [resL, resC] = await Promise.all([fetch('/get-history?t=' + Date.now()), fetch('/get-clicks?t=' + Date.now())]);
        const l = await resL.json(); const c = await resC.json();
        if (Array.isArray(l)) leadsData = l;
        if (Array.isArray(c)) clicksData = c;
        updateDisplay();
    } catch (e) {}
}

const pusher = new Pusher('6bc0867b80098f3e3424', { cluster: 'ap1' });
const channel = pusher.subscribe('my-channel');
channel.bind('new-lead', d => handleData(d, 'LEAD', true));
channel.bind('new-click', d => handleData(d, 'CLICK', false));

autoSync(); setInterval(autoSync, 15000);
switchView('live');
</script>
</body>
</html>
