<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>R.O.W.X Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --text: #c9d1d9; --border: #30363d; --sub: #8b949e; --accent: #00f2ff; }
        .light-mode { --bg: #f0f2f5; --card: #ffffff; --text: #1a1d21; --border: #d0d7de; --sub: #57606a; --accent: #0077ff; }
        
        body { font-family: 'JetBrains Mono', monospace; background: var(--bg); color: var(--text); overflow: hidden; font-size: 11px; }
        .font-rowx { font-family: 'Orbitron', sans-serif; }
        
        nav { display: flex; align-items: center; padding: 0 16px; height: 55px; background: var(--card); border-bottom: 1px solid var(--border); }
        .logo-area { display: flex; flex-direction: column; line-height: 1; min-width: 110px; }
        .phei-text { font-family: 'Orbitron', sans-serif; font-size: 6px; letter-spacing: 1.5px; color: var(--sub); opacity: 0.6; margin-top: 3px; }

        /* FIXED SMOOTH MARQUEE */
        .marquee-container { 
            flex: 1; margin: 0 20px; overflow: hidden; 
            border-left: 1px solid var(--border); border-right: 1px solid var(--border); 
            height: 100%; display: flex; align-items: center;
            animation: fadeInMarquee 1s ease-in-out forwards; /* Fade in saat reload biar gak kaget */
        }
        .marquee-wrapper { display: flex; width: max-content; animation: scroll-continuous 30s linear infinite; }
        .marquee-item { 
            white-space: nowrap; padding-right: 60px; 
            color: var(--accent); font-size: 10px; font-weight: 800; 
            text-shadow: 0 0 10px rgba(0, 242, 255, 0.2); letter-spacing: 1.5px;
        }

        @keyframes scroll-continuous {
            from { transform: translateX(0); }
            to { transform: translateX(-50%); }
        }

        @keyframes fadeInMarquee {
            from { opacity: 0; transform: translateY(2px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* SIDEBAR & TABLE STYLING */
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { background: var(--card); color: var(--sub); font-size: 9px; padding: 10px 16px; text-align: left; border-bottom: 1px solid var(--border); }
        td { padding: 8px 16px; border-bottom: 1px solid var(--border); }

        .theme-btn { 
            width: 36px; height: 36px; border-radius: 10px; border: 1px solid var(--border);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.3s; background: rgba(255,255,255,0.02); position: relative;
        }
        .theme-btn:hover { border-color: var(--accent); background: rgba(0, 242, 255, 0.05); }
        .sun-icon, .moon-icon { position: absolute; width: 18px; height: 18px; transition: 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        
        .dark-mode .sun-icon { opacity: 1; transform: scale(1) rotate(0); color: #ffcc00; }
        .dark-mode .moon-icon { opacity: 0; transform: scale(0) rotate(-90deg); }
        .light-mode .sun-icon { opacity: 0; transform: scale(0) rotate(90deg); }
        .light-mode .moon-icon { opacity: 1; transform: scale(1) rotate(0); color: #0077ff; }

        #sidebar { position: fixed; right: 20px; top: -100%; width: 280px; background: var(--card); border: 1px solid var(--border); z-index: 100; border-radius: 0 0 12px 12px; transition: 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28); box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
        #sidebar.open { top: 55px; }
    </style>
</head>
<body class="dark-mode">
    <audio id="leadSound" src="https://kokoya.pages.dev/kaya.mp3" preload="auto"></audio>
    
    <nav>
        <div class="logo-area">
            <span class="text-2xl font-bold font-rowx text-blue-500">R.O.W.X</span>
            <span class="phei-text uppercase">PHEI EDITION 2026</span>
        </div>
        <div class="marquee-container">
            <div class="marquee-wrapper">
                <div class="marquee-item">DI DALAM DUNIA MAYA IMAJINASI ADALAH SENJATA //</div>
                <div class="marquee-item">DI DALAM DUNIA MAYA IMAJINASI ADALAH SENJATA //</div>
                <div class="marquee-item">DI DALAM DUNIA MAYA IMAJINASI ADALAH SENJATA //</div>
                <div class="marquee-item">DI DALAM DUNIA MAYA IMAJINASI ADALAH SENJATA //</div>
            </div>
        </div>
        <div class="flex items-center gap-3 ml-4">
            <div class="theme-btn" onclick="document.body.classList.toggle('light-mode')">
                <svg class="sun-icon" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"/></svg>
                <svg class="moon-icon" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/></svg>
            </div>
            <div class="theme-btn" onclick="document.getElementById('sidebar').classList.toggle('open')">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </div>
        </div>
    </nav>

    <main class="overflow-y-auto h-[calc(100vh-55px)]">
        <table id="target-table">
            <thead>
                <tr>
                    <th style="width: 20%">TEAM/OID</th>
                    <th style="width: 35%">CLICK ID</th>
                    <th style="width: 15%">COUNTRY</th>
                    <th style="width: 15%; text-align: center">TIME</th>
                    <th style="width: 15%; text-align: right">PAYOUT</th>
                </tr>
            </thead>
            <tbody id="main-table-body"></tbody>
        </table>
    </main>

    <div id="sidebar">
        <div class="p-4 border-b border-[var(--border)] flex justify-between items-center text-[10px] font-bold text-blue-400">
            <span>LIVE TRAFFIC</span>
            <button onclick="document.getElementById('sidebar').classList.remove('open')" class="text-xl">&times;</button>
        </div>
        <div id="activity-stream" class="p-4 space-y-2"></div>
    </div>

    <script>
        const mainTable = document.getElementById('main-table-body');
        const stream = document.getElementById('activity-stream');
        let allTraffic = JSON.parse(localStorage.getItem('phei_cache') || '[]');

        function renderUI(latestId = null) {
            const leads = allTraffic.filter(d => d.type === 'LEAD');
            const clicks = allTraffic.filter(d => d.type === 'CLICK').slice(0, 5);
            const maxVal = leads.length > 0 ? Math.max(...leads.map(l => l.payout)) : -1;

            mainTable.innerHTML = leads.map(d => {
                const isK = d.payout > 0 && d.payout === maxVal;
                const cc = (d.country || 'id').toLowerCase();
                return `<tr class="${latestId === d.click_id ? 'bg-cyan-500/10' : ''} border-b border-[var(--border)]">
                    <td class="font-bold ${isK ? 'text-yellow-500' : 'text-cyan-400'} uppercase">${d.oid}</td>
                    <td class="text-gray-500 text-[10px]">${d.click_id}</td>
                    <td><div class="flex items-center gap-2"><img src="https://flagicons.lipis.dev/flags/4x3/${cc}.svg" class="w-4 shadow">${cc.toUpperCase()}</div></td>
                    <td class="text-center opacity-40 text-[9px]">${new Date(d.timestamp).toLocaleTimeString()}</td>
                    <td class="text-right font-bold text-green-400">$${d.payout.toFixed(2)}</td>
                </tr>`;
            }).join('');

            stream.innerHTML = clicks.map(d => {
                const cc = (d.country || 'id').toLowerCase();
                return `<div class="p-2 border border-[var(--border)] rounded bg-black/10 flex justify-between items-center text-[9px]">
                    <div class="flex flex-col"><span class="text-cyan-400 font-bold">CLICK</span><span class="text-gray-500 truncate w-28">${d.click_id}</span></div>
                    <img src="https://flagicons.lipis.dev/flags/4x3/${cc}.svg" class="w-4 shadow">
                </div>`;
            }).join('');
            localStorage.setItem('phei_cache', JSON.stringify(allTraffic));
        }

        renderUI();
        fetch('/get-history').then(r => r.json()).then(d => { if (Array.isArray(d)) { allTraffic = d; renderUI(); } });

        const pusher = new Pusher('6bc0867b80098f3e3424', { cluster: 'ap1' });
        const channel = pusher.subscribe('my-channel');
        const handle = (d, type) => {
            allTraffic.unshift({...d, type});
            if (allTraffic.length > 100) allTraffic.pop();
            if (type === 'LEAD') document.getElementById('leadSound').play().catch(()=>{});
            renderUI(d.click_id);
        };
        channel.bind('new-lead', d => handle(d, 'LEAD'));
        channel.bind('new-click', d => handle(d, 'CLICK'));
    </script>
</body>
</html>
