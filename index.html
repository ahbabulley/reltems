<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R.O.W.X PHEI 2026</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --text: #c9d1d9; --border: #30363d; --sub-text: #8b949e; }
        .light-mode { --bg: #ffffff; --card: #f6f8fa; --text: #24292f; --border: #d0d7de; --sub-text: #57606a; }
        body { font-family: 'JetBrains Mono', monospace; background-color: var(--bg); color: var(--text); overflow: hidden; transition: 0.3s; }
        .font-rowx { font-family: 'Orbitron', sans-serif; }
        nav { display: flex; align-items: center; padding: 0 24px; height: 75px; background: var(--card); border-bottom: 1px solid var(--border); }
        .logo-area { display: flex; flex-direction: column; line-height: 1; shrink-0; }
        .phei-text { font-family: 'Orbitron', sans-serif; font-size: 7px; letter-spacing: 0.12em; color: rgba(139, 148, 158, 0.4); font-weight: 700; margin-top: 5px; }
        .marquee-container { flex: 1; height: 100%; overflow: hidden; margin: 0 20px; border-left: 1px solid var(--border); border-right: 1px solid var(--border); display: flex; align-items: center; white-space: nowrap; }
        .marquee-text { display: inline-block; animation: marquee 25s linear infinite; font-size: 11px; font-weight: 700; color: var(--sub-text); }
        @keyframes marquee { from { transform: translateX(100%); } to { transform: translateX(-100%); } }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { background: var(--card); color: var(--sub-text); font-size: 11px; padding: 14px 24px; border-bottom: 2px solid var(--border); text-align: left; }
        td { padding: 14px 24px; border-bottom: 1px solid var(--border); font-size: 13px; font-weight: 500; }
        .theme-box { background: var(--bg); border: 1px solid var(--border); width: 42px; height: 42px; border-radius: 10px; display: flex; align-items: center; justify-content: center; shrink-0; }
/* Cari dan ganti bagian ini di index.html */
#sidebar { 
    position: absolute; 
    right: 24px; 
    top: -100vh; /* Sembunyi jauh di atas */
    width: 350px; 
    /* Hapus height tetap (78vh), biarkan mengikuti konten */
    background: var(--card); 
    border: 1px solid var(--border); 
    z-index: 100; 
    border-radius: 0 0 15px 15px; 
    transition: top 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.1); 
    display: flex; 
    flex-direction: column; 
    box-shadow: 0 20px 50px rgba(0,0,0,0.4); 
    max-height: 85vh; /* Batas maksimal agar tidak tembus layar bawah */
}

#sidebar.open { 
    top: 75px; 
}

/* Pastikan area stream tidak memaksa tinggi tertentu */
#activity-stream { 
    overflow-y: auto; 
    padding: 16px; 
    display: flex;
    flex-direction: column;
    gap: 8px; /* Jarak antar kotak agar rapi */
}
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; animation: pulse 1.5s infinite; }
        .dot-red { background: #ff4444; } .dot-yellow { background: #ffbb33; animation-delay: 0.3s; } .dot-green { background: #00c851; animation-delay: 0.6s; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        .row-animate { animation: rowIn 1.2s ease-out; }
        @keyframes rowIn { from { background: rgba(59, 130, 246, 0.25); } to { background: transparent; } }
    </style>
</head>
<body class="dark-mode">
    <audio id="leadSound" src="https://kokoya.pages.dev/kaya.mp3" preload="auto"></audio>
    <div class="flex flex-col h-screen relative">
        <nav>
            <div class="logo-area">
                <span class="text-2xl font-bold font-rowx text-blue-500">R.O.W.X</span>
                <span class="phei-text">PHEI EDITION 2026</span>
            </div>
            <div class="marquee-container"><div class="marquee-text uppercase">NODE: ASIA-1 // STATUS: SECURE // EDITION: PHEI 2026 // LIVE MONITORING...</div></div>
            <div class="flex items-center gap-4">
                <div class="theme-box"><button onclick="toggleTheme()" class="w-full h-full flex items-center justify-center text-gray-400 hover:text-blue-500"><svg id="sun-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" class="w-5 h-5 block"><path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.364 17.636l-.707.707M6.364 6.364l.707.707m10.607 10.607l.707.707M12 8a4 4 0 110 8 4 4 0 010-8z" stroke-width="2"></path></svg><svg id="moon-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" class="w-5 h-5 hidden"><path d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" stroke-width="2"></path></svg></button></div>
                <button onclick="toggleSidebar()" class="text-gray-400 hover:text-white"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg></button>
            </div>
        </nav>
        <main class="flex-1 overflow-y-auto">
            <table>
                <thead><tr><th style="width: 22%;">TEAM / OID</th><th style="width: 33%;">CLICK ID</th><th style="width: 15%;">COUNTRY</th><th style="width: 15%; text-align: center;">TIME</th><th style="width: 15%; text-align: right;">PAYOUT</th></tr></thead>
                <tbody id="main-table-body"></tbody>
            </table>
        </main>
        <aside id="sidebar">
            <div class="p-5 border-b border-[var(--border)] flex justify-between items-center bg-[var(--card)]">
                <div class="flex items-center gap-3"><span class="text-[10px] font-bold uppercase tracking-widest text-blue-500">Live Traffic</span><div class="flex gap-1.5"><span class="status-dot dot-red"></span><span class="status-dot dot-yellow"></span><span class="status-dot dot-green"></span></div></div>
                <button onclick="toggleSidebar()" class="text-gray-500 text-2xl">&times;</button>
            </div>
            <div id="activity-stream" class="flex-1 overflow-y-auto p-4 space-y-2"></div>
        </aside>
    </div>
<script>
// Konfigurasi Dasar
const mainTable = document.getElementById('main-table-body');
const stream = document.getElementById('activity-stream');
const leadSound = new Audio('https://kokoya.pages.dev/kaya.mp3');
const synth = window.speechSynthesis;

let leadsData = [];
let processedClickIds = new Set(); // Biar click ga double

// 1. Pancing Suara (Wajib Klik 1x di Layar setelah buka web)
document.addEventListener('click', () => {
    leadSound.play().then(() => { leadSound.pause(); leadSound.currentTime = 0; }).catch(()=>{});
}, { once: true });

// 2. Fungsi Suara Google & Notifikasi
function speakAndNotify(title, msg) {
    // Notifikasi Chrome/Windows
    if (Notification.permission === "granted") {
        new Notification(title, { body: msg });
    }
    // Suara Google
    const utter = new SpeechSynthesisUtterance(msg);
    utter.lang = 'id-ID';
    synth.speak(utter);
}

// 3. Update Tabel Lead Utama
function updateTable() {
    mainTable.innerHTML = "";
    leadsData.forEach((data) => {
        const row = mainTable.insertRow();
        row.innerHTML = `
            <td class="p-3 font-bold text-blue-500 uppercase">${data.oid || 'USER'}</td>
            <td class="text-gray-400 font-mono">${data.click_id}</td>
            <td><img src="https://flagicons.lipis.dev/flags/4x3/${(data.country||'id').toLowerCase()}.svg" class="w-6"></td>
            <td class="text-gray-500 text-xs">${new Date(data.timestamp || Date.now()).toLocaleTimeString()}</td>
            <td class="font-bold text-green-500 text-right">$${parseFloat(data.payout).toFixed(2)}</td>
        `;
    });
}

// 4. Logika Utama Data Masuk
function handleData(data, type, isNew = false) {
    if (type === 'LEAD') {
        // Cek apakah lead sudah ada
        if (!leadsData.some(l => l.click_id === data.click_id)) {
            leadsData.unshift(data);
            if (leadsData.length > 50) leadsData.pop();
            updateTable();
            if (isNew) {
                leadSound.play().catch(()=>{});
                speakAndNotify("LEAD BARU", "Ada uang masuk dari ID " + data.click_id.substring(0,5));
            }
        }
    } else if (type === 'CLICK') {
        // Cek apakah click sudah ada di tampilan
        if (!processedClickIds.has(data.click_id)) {
            processedClickIds.add(data.click_id);
            
            const item = document.createElement('div');
            item.className = "p-3 border border-[var(--border)] rounded-lg bg-[var(--card)] flex justify-between items-center type-CLICK mb-2";
            item.innerHTML = `
                <div>
                    <span class="text-[9px] font-bold text-blue-500 uppercase">CLICK</span>
                    <div class="text-[11px] text-gray-400 font-mono truncate w-40">${data.click_id}</div>
                </div>
                <img src="https://flagicons.lipis.dev/flags/4x3/${(data.country||'id').toLowerCase()}.svg" class="w-5">`;
            
            stream.prepend(item);

            // Batasi 5 kotak saja
            const boxes = stream.querySelectorAll('.type-CLICK');
            if (boxes.length > 5) {
                // Hapus ID dari tracker sebelum hapus kotak
                const lastId = boxes[boxes.length-1].querySelector('.font-mono').innerText;
                processedClickIds.delete(lastId);
                stream.removeChild(boxes[boxes.length-1]);
            }

            if (isNew) {
                speakAndNotify("CLICK BARU", "Klik baru terdeteksi");
            }
        }
    }
}

// 5. Fungsi Ambil Data dari Server
async function loadFromServer() {
    try {
        const resL = await fetch('/get-history');
        const leads = await resL.json();
        if (Array.isArray(leads)) leads.reverse().forEach(l => handleData(l, 'LEAD', false));

        const resC = await fetch('/get-clicks');
        const clicks = await resC.json();
        if (Array.isArray(clicks)) clicks.reverse().forEach(c => handleData(c, 'CLICK', false));
    } catch (e) { console.error("Gagal ambil data"); }
}

// 6. Jalankan Sistem
if (Notification.permission !== "granted") Notification.requestPermission();
loadFromServer(); // Ambil saat pertama buka
setInterval(loadFromServer, 3000); // Cek data baru tiap 3 detik

// 7. Pusher (Instan)
const pusher = new Pusher('6bc0867b80098f3e3424', { cluster: 'ap1' });
const channel = pusher.subscribe('my-channel');
channel.bind('new-lead', d => handleData(typeof d === 'string' ? JSON.parse(d) : d, 'LEAD', true));
channel.bind('new-click', d => handleData(typeof d === 'string' ? JSON.parse(d) : d, 'CLICK', true));

function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
</script>
</body>
</html>
