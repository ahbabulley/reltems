<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHEI REALTIME 2026</title><link rel="icon" href="icon.png" type="image/png">
<link rel="shortcut icon" href="icon.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --text: #c9d1d9; --border: #30363d; --sub-text: #8b949e; }
        .light-mode { --bg: #ffffff; --card: #f6f8fa; --text: #24292f; --border: #d0d7de; --sub-text: #57606a; }
        body { font-family: 'JetBrains Mono', monospace; background-color: var(--bg); color: var(--text); overflow: hidden; transition: 0.3s; }
        .font-rowx { font-family: 'Orbitron', sans-serif; }
        nav { display: flex; align-items: center; padding: 0 24px; height: 75px; background: var(--card); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 50; }
        .marquee-container { flex: 1; height: 100%; overflow: hidden; margin: 0 20px; border-left: 1px solid var(--border); border-right: 1px solid var(--border); display: flex; align-items: center; }
        .marquee-text { display: inline-block; animation: marquee 25s linear infinite; font-size: 11px; font-weight: 700; color: var(--sub-text); white-space: nowrap; }
        @keyframes marquee { from { transform: translateX(100%); } to { transform: translateX(-100%); } }
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--card); color: var(--sub-text); font-size: 10px; padding: 12px 24px; border-bottom: 2px solid var(--border); text-align: left; text-transform: uppercase; letter-spacing: 1px; }
        td { padding: 12px 24px; border-bottom: 1px solid var(--border); font-size: 13px; }
        .theme-box { background: var(--bg); border: 1px solid var(--border); width: 42px; height: 42px; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        #nav-popup-menu { backdrop-filter: blur(10px); background: rgba(22, 27, 34, 0.95); box-shadow: 0 10px 40px rgba(0,0,0,0.6); }
        .search-input { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 5px 12px; border-radius: 6px; font-size: 11px; outline: none; width: 220px; }
    </style>
</head>
<body class="dark-mode">
    <div class="flex flex-col h-screen relative">
        <nav>
            <div class="logo-area flex flex-col shrink-0">
                <span class="text-2xl font-bold font-rowx text-blue-500">R.O.W.X</span>
                <span class="text-[7px] font-bold tracking-[0.2em] opacity-40">PHEI EDITION 2026</span>
            </div>
            <div class="marquee-container"><div class="marquee-text uppercase" id="marquee-text">WAITING FOR DATA...</div></div>
            <div class="flex items-center gap-4">
                <div class="theme-box" onclick="toggleTheme()">
                    <svg id="sun-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" class="w-5 h-5 block"><path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.364 17.636l-.707.707M6.364 6.364l.707.707m10.607 10.607l.707.707M12 8a4 4 0 110 8 4 4 0 010-8z" stroke-width="2"></path></svg>
                    <svg id="moon-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" class="w-5 h-5 hidden"><path d="M21.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" stroke-width="2"></path></svg>
                </div>
                <button onclick="openMenuPopup()" class="text-gray-400 hover:text-white transition-all active:scale-90">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
        </nav>

        <main class="flex-1 overflow-y-auto">
            <div class="p-4 border-b border-[var(--border)] bg-[var(--card)]/30 flex justify-between items-center">
                <h2 id="view-title" class="text-[10px] font-bold text-blue-500 uppercase tracking-[0.3em]">ðŸš€ REALTIME LEADS</h2>
                <div id="search-container" class="hidden">
                    <input type="text" id="clickSearch" class="search-input" placeholder="Cari ID / Negara..." onkeyup="filterClicks()">
                </div>
            </div>
            <table id="data-table">
                <thead id="table-head"></thead>
                <tbody id="main-table-body"></tbody>
            </table>
        </main>
    </div>

<script>
const mainTable = document.getElementById('main-table-body');
const tableHead = document.getElementById('table-head');
const synth = window.speechSynthesis;
let leadsData = [];
let clicksData = [];
let currentView = 'live';
function getFlag(country) {
    if (!country) return 'id'; 
    let code = country.toLowerCase();
    return code === 'uk' ? 'gb' : code;
// Ikon hanya untuk Performance
const crownSvg = `<svg class="w-5 h-5 text-yellow-500 animate-bounce" viewBox="0 0 24 24" fill="currentColor"><path d="M5 16L3 5L8.5 10L12 4L15.5 10L21 5L19 16H5M19 19C19 19.6 18.6 20 18 20H6C5.4 20 5 19.6 5 19V18H19V19Z"/></svg>`;
const userSvg = `<svg class="w-5 h-5 opacity-20" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>`;

function openMenuPopup() {
    const existing = document.getElementById('nav-popup-menu');
    if (existing) { existing.remove(); return; }
    const menu = document.createElement('div');
    menu.id = 'nav-popup-menu';
    menu.className = "fixed top-16 right-4 w-56 border border-[var(--border)] rounded-xl z-[999] p-2 flex flex-col gap-1 shadow-2xl";
    menu.innerHTML = `
        <button onclick="switchView('live')" class="flex items-center gap-3 p-3 rounded-lg hover:bg-blue-500/10 text-white w-full"><svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg><span class="font-bold text-[10px] uppercase">Realtime Leads</span></button>
        <button onclick="switchView('perf')" class="flex items-center gap-3 p-3 rounded-lg hover:bg-green-500/10 text-white w-full"><svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M18 20V10M12 20V4M6 20v-6"/></svg><span class="font-bold text-[10px] uppercase">Performance</span></button>
        <button onclick="switchView('traffic')" class="flex items-center gap-3 p-3 rounded-lg hover:bg-purple-500/10 text-white w-full"><svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg><span class="font-bold text-[10px] uppercase">Live Traffic</span></button>
    `;
    document.body.appendChild(menu);
    setTimeout(() => document.addEventListener('click', (e) => { if(!menu.contains(e.target)) menu.remove(); }, {once:true, capture:true}), 10);
}

function switchView(view) {
    currentView = view;
    document.getElementById('search-container').classList.toggle('hidden', view !== 'traffic');
    const title = document.getElementById('view-title');
    if(view === 'live') title.innerText = "REALTIME LEADS";
    else if(view === 'perf') title.innerText = "PERFORMANCE";
    else title.innerText = "LIVE TRAFFIC (CLICKS)";
    updateDisplay();
}

function updateDisplay() {
    mainTable.innerHTML = "";
    let kingId = "";
    let topVal = 0;

    if (currentView === 'live' || currentView === 'perf') {
        tableHead.innerHTML = `<tr><th width="20%">USER</th><th width="35%">CLICK ID</th><th width="15%">COUNTRY</th><th width="15%" class="text-center">INFO</th><th width="15%" class="text-right">PAYOUT</th></tr>`;
        let renderData = [];
        
        if(currentView === 'live') {
            renderData = leadsData;
            // Cari data tertinggi hanya untuk Marquee
            leadsData.forEach(l => { if(parseFloat(l.payout) >= topVal) { topVal = parseFloat(l.payout); kingId = l.click_id; } });
        } else {
            const perfMap = {};
            leadsData.forEach(l => {
                if(!perfMap[l.click_id]) perfMap[l.click_id] = {...l, total:0, count:0};
                perfMap[l.click_id].total += parseFloat(l.payout);
                perfMap[l.click_id].count++;
            });
            renderData = Object.values(perfMap).sort((a,b) => b.total - a.total);
            if(renderData[0]) { kingId = renderData[0].click_id; topVal = renderData[0].total; }
        }

        renderData.forEach(d => {
            const isKing = d.click_id === kingId && kingId !== "";
            const pValue = currentView === 'perf' ? d.total : parseFloat(d.payout);
            const row = mainTable.insertRow();
            
            // Logika Ikon: Hanya muncul jika di View Performance
            let iconHtml = "";
            if(currentView === 'perf') {
                iconHtml = isKing ? crownSvg : userSvg;
            }

            row.innerHTML = `
                <td class="p-4">
                    <div class="flex items-center gap-2">
                        ${iconHtml}
                        <span class="font-bold ${isKing && currentView === 'perf' ? 'text-yellow-500' : 'text-blue-500'} uppercase">${d.oid||'USR'}</span>
                    </div>
                </td>
                <td class="font-mono text-xs opacity-50 truncate">${d.click_id}</td>
                <td>
                    <div class="flex items-center gap-2">
                        <img src="https://flagicons.lipis.dev/flags/4x3/${(d.country||'id').toLowerCase()}.svg" class="w-5 shadow">
                        <span class="text-[10px] font-bold uppercase">${d.country||'ID'}</span>
                    </div>
                </td>
                <td class="text-center text-[10px] opacity-50">
                    ${currentView==='perf' ? d.count+' LEADS' : new Date(d.timestamp).toLocaleTimeString()}
                </td>
                <td class="text-right font-bold text-green-500">$${pValue.toFixed(2)}</td>
            `;
        });
        
        const m = document.getElementById('marquee-text');
        if(m && kingId) m.innerHTML = `TOP RECORD: <span class="text-yellow-500">${kingId}</span> // VALUE: <span class="text-green-500">$${topVal.toFixed(2)}</span>SEMANGAT...`;
    } else {
        tableHead.innerHTML = `<tr><th width="40%">CLICK ID</th><th width="20%">COUNTRY</th><th width="20%">STATUS</th><th width="20%" class="text-right">TIME</th></tr>`;
        filterClicks();
    }
}

function filterClicks() {
    if(currentView !== 'traffic') return;
    const s = document.getElementById('clickSearch').value.toLowerCase();
    mainTable.innerHTML = "";
    clicksData.forEach(c => {
        if(c.click_id.toLowerCase().includes(s) || (c.country||'').toLowerCase().includes(s)) {
            const row = mainTable.insertRow();
            row.innerHTML = `<td class="p-4 font-mono text-xs text-blue-400">${c.click_id}</td><td><div class="flex items-center gap-2"><img src="https://flagicons.lipis.dev/flags/4x3/${(c.country||'id').toLowerCase()}.svg" class="w-5"><span class="text-[10px] font-bold uppercase">${c.country||'ID'}</span></div></td><td><span class="text-[9px] bg-blue-500/10 text-blue-400 px-2 py-0.5 rounded">CLICKED</span></td><td class="text-right text-[10px] opacity-40">${new Date().toLocaleTimeString()}</td>`;
        }
    });
}

function handleData(data, type, isNew = false) {
    if (type === 'LEAD') {
        leadsData.unshift(data);
        if (leadsData.length > 500) leadsData.pop();
        updateDisplay(); 
        if (isNew) {
            function sendSystemNotif(payout, clickId) {
    if (Notification.permission === "granted") {
        new Notification("ðŸ”¥ LEAD MASUK!", {
            body: `ID: ${clickId} | Payout: $${payout}`,
            icon: "icon.png" 
        });
    }
}
            if (Notification.permission === "granted") {
                new Notification("ðŸ”¥ LEAD MASUK!", { body: `$${data.payout} - ID: ${data.click_id}` });
            }
            synth.cancel();
            const utter = new SpeechSynthesisUtterance(`Lead ${data.payout} dolar.`);
            utter.lang = 'id-ID';
            synth.speak(utter);

            const botToken = "8294616704:AAF7M8RQkNKdkJeNvVdeGFG7zrU26vo7sao";
            const chatId = "-1002258281914";
            fetch(`https://api.telegram.org/bot${botToken}/sendMessage?chat_id=${chatId}&text=${encodeURIComponent('ðŸ”¥ *LEAD MASUK!* ðŸ”¥\n\nðŸ†” ID: `' + data.click_id + '` \nðŸ’° Payout: $' + data.payout)}&parse_mode=Markdown`).catch(e => {});
        }
    } else {
        clicksData.unshift(data);
        if (clicksData.length > 200) clicksData.pop();
        if(currentView === 'traffic') updateDisplay();
    }
}

function toggleTheme() {
    const isLight = document.body.classList.toggle('light-mode');
    document.getElementById('sun-icon').classList.toggle('hidden', isLight);
    document.getElementById('moon-icon').classList.toggle('hidden', !isLight);
}

setInterval(() => {
    const now = new Date();
    if (now.getHours() === 7 && now.getMinutes() === 0 && now.getSeconds() === 0) {
        leadsData = []; clicksData = []; mainTable.innerHTML = "";
    }
}, 1000);

async function autoSync() {
    try {
        const [resL, resC] = await Promise.all([fetch('/get-history?t=' + Date.now()), fetch('/get-clicks?t=' + Date.now())]);
        const l = await resL.json(); const c = await resC.json();
        if (Array.isArray(l)) leadsData = l;
        if (Array.isArray(c)) clicksData = c;
        updateDisplay();
    } catch (e) {}
}

const pusher = new Pusher('6bc0867b80098f3e3424', { cluster: 'ap1' });
const channel = pusher.subscribe('my-channel');
channel.bind('new-lead', d => handleData(typeof d === 'string' ? JSON.parse(d) : d, 'LEAD', true));
channel.bind('new-click', d => handleData(typeof d === 'string' ? JSON.parse(d) : d, 'CLICK', false));

autoSync();
setInterval(autoSync, 10000);
document.addEventListener('click', () => { if(Notification.permission!=='granted') Notification.requestPermission(); }, {once:true});

    
</script>
</body>
</html>
